---
sidebar: auto
---

# 响应式系统的基本原理

## 响应式系统

Vue.js 是一款 MVVM 框架库，数据模型仅仅是普通的 JavaScript 对象，但是对这些对象进行操作时，却能影响对应视图，它的核心实现就是 **响应式系统**。尽管在使用 Vue.js 进行开发时不会直接修改 **响应式系统**，但是理解它的实现原理有助于避开一些常见的 **坑**，也有助于在遇见一些莫名其妙的问题时可以深入其原理来解决它

## `Object.defineProperty`

首先了解一下 `Object.defineProperty`，Vue.js 就是基于这个 API 实现 **响应式系统** 的

使用方法：

```javascript
/**
 * 属于 ECMAScript5.1 规范
 * obj：目标对象
 * prop：需要操作的目标对象的属性名
 * descriptor：描述对象
 *
 * return value 传入的对象
 */

Object.defineProperty(obj, prop, descriptor)
```

descriptor 的一些属性，具体可以参考 [MDN 文档](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty):

- `enumerable`：属性是否可以枚举，默认 `false`'
- `configurable`：属性是否可以被修改或者删除，默认 `false`
- `get`：获取属性时调用的方法
- `set`：设置属性时调用的方法

## 实现 `observer`（可观察的）

了解了 `Object.defineProperty` 以后，来用它使对象变成可观察的

在 `init` 的阶段会进行初始化，对数据进行 **响应式化**

![初始化](./image/001002.png)

为了便于理解，不考虑数组等复杂的情况，只对对象进行处理

首先定义一个 `updateView` 函数，这个函数用来模拟视图更新，调用它即代表更新视图，内部可以是一些更新视图的方法

```javascript
function updateView() {
  /* 更新视图 */
  console.log('视图更新了')
}
```

然后定义一个 `defineReactive`方法，该方法通过 `Object.defineProperty` 来实现对对象的 **响应式化**，入参是一个 obj (需要绑定的对象)、key（obj 的某个属性）、val（具体的值）。经过 `defineReactive` 处理以后，obj 的 key 属性在 **读** 的时候会触发 `reactiveGetter` 方法，而在该属性被 **写** 的时候则会触发 `reactiveSetter` 方法

```javascript
/**
 * obj：需要绑定的对象
 * key：对象的属性
 * val：具体的值
 */
function defineReactive(obj, key, val) {
  Object.defineProperty(obj, key, {
    enumerable: true, // key 属性设置为可枚举
    configurable: true, // key 属性可被修改或删除
    get: function reactiveGetter() {
      return val // 实际上会依赖收集，在后面
    },
    set: function reactiveSetter(newVal) {
      if (newVal === val) return
      updateView(newVal) // 根据依赖收集，更新视图
    }
  })
}
```

当然这是不够的，需要在上面再封装一层 `observer`。该函数传入一个 obj (需要 **响应式化** 的对象)，通过遍历所有属性的方式，对该对象的每一个属性都通过 `defineReactive` 处理（注：实际上，`observer` 会进行递归调用，为了便于作者理解去掉了递归的过程）

```javascript
function observer(obj) {
  if (!obj || typeof Obj !== 'object') {
    return
  }

  // 这儿应该是递归调用的过程
  Object.keys(obj).foreach(key => {
    defineReactive(obj, key, obj[key])
  })
}
```

最后，用 `observer` 来封装一个 Vue 类

在 Vue 类的构造函数中，对 `options` 的 `data` 进行处理，这里的 `data` 想必很熟悉，就是平时在写 Vue 组件中的 `data` 属性（实际上是一个函数，这里当做一个对象来简单处理）

```javascript
class Vue {
  constructor(options) {
    this._data = options.data
    observer(this._data)
  }
}
```

这样只要 `new` 一个 Vue 对象，就会将 `data` 中的数据进行 **响应式化**。如果对 `data` 的属性进行下面的操作，就会触发 `updateView` 方法更新视图

```javascript
let vm = new Vue({
  data: {
    test: '测试文字'
  }
})

vm._data.test = '测试文字' // 打印 视图更新了
```
